---
title: "Project Plan"
author: "Don Ngo"
date: "`r Sys.Date()`"
output: pdf_document
---

#Packages (to be adjusted)
```{r}
library(cry)
library(data.table)
library(readtext)
library(stringr)
```

# General Objectives
- Create a private GitHub repository.
- Extract information from crystallography files.
- Identify necessary information for cluster analyses.
- Build functions.
- Build a package.

# Specific Objectives and Tasks

## Task 1: Create a Private GitHub Repository

**Action:** Set up a private repository on GitHub.  
**Requirement:** Each code segment added should be accompanied by an explanation.

## Task 2: Bind CIF Files into One Table

**Steps:**

1. **Download CIF files from the provided Google Drive link.**

2. **Set the working directory:**

```{r}
setwd('/Users/dngo/repos/ml-crystals/data')
```

3. **List CIF files**

```{r}
cif_list <- list.files(pattern="\\.cif$", full.names = TRUE)
cif_tab <- lapply(cif_list, readLines )
```

#Task 3: Extracting Data

```{r}
extract_chemical_formula <- function(cif_content) {
  formula_lines <- grep("_chemical_formula_sum", cif_content, value = TRUE)
  if (length(formula_lines) > 0) {
    chemical_formula <- gsub("_chemical_formula_sum", "", formula_lines)
    chemical_formula <- gsub("'", "", chemical_formula)
    chemical_formula <- trimws(chemical_formula)
    return(chemical_formula)
  } else {
    return(NA)
  }
}

extract_structure_type <- function(cif_content) {
  structure_lines <- grep("_chemical_name_structure_type", cif_content, value = TRUE)
  if (length(structure_lines) > 0) {
    structure_type <- gsub("_chemical_name_structure_type", "", structure_lines)
    structure_type <- gsub("'", "", structure_type)
    structure_type <- trimws(structure_type)
    return(structure_type)
  } else {
    return(NA)
  }
}

extract_space_group_name <- function(cif_content) {
  space_group_lines <- grep("_space_group_name_H-M_alt", cif_content, value = TRUE)
  if (length(space_group_lines) > 0) {
    space_group <- gsub("_space_group_name_H-M_alt", "", space_group_lines)
    space_group <- gsub("'", "", space_group)
    space_group <- trimws(space_group)
    return(space_group)
  } else {
    return(NA)
  }
}

extract_space_group_number <- function(cif_content) {
  space_group_number_lines <- grep("_space_group_IT_number", cif_content, value = TRUE)
  if (length(space_group_number_lines) > 0) {
    space_group_number <- gsub("_space_group_IT_number", "", space_group_number_lines)
    space_group_number <- trimws(space_group_number)
    return(space_group_number)
  } else {
    return(NA)
  }
}

extract_reference_info <- function(cif_content) {
  citation_lines <- grep("_citation_", cif_content, value = TRUE)
  if (length(citation_lines) > 0) {
    authors <- grep("_citation_author_name", cif_content, value = TRUE)
    authors <- gsub("_citation_author_name", "", authors)
    authors <- gsub("'", "", authors)
    authors <- trimws(authors)
    
    title <- grep("_citation_title", cif_content, value = TRUE)
    title <- gsub("_citation_title", "", title)
    title <- gsub("'", "", title)
    title <- trimws(title)
    
    journal <- grep("_citation_journal_full", cif_content, value = TRUE)
    journal <- gsub("_citation_journal_full", "", journal)
    journal <- gsub("'", "", journal)
    journal <- trimws(journal)
    
    year <- grep("_citation_year", cif_content, value = TRUE)
    year <- gsub("_citation_year", "", year)
    year <- trimws(year)
    
    volume <- grep("_citation_journal_volume", cif_content, value = TRUE)
    volume <- gsub("_citation_journal_volume", "", volume)
    volume <- trimws(volume)
    
    pages_first <- grep("_citation_page_first", cif_content, value = TRUE)
    pages_first <- gsub("_citation_page_first", "", pages_first)
    pages_first <- trimws(pages_first)
    
    pages_last <- grep("_citation_page_last", cif_content, value = TRUE)
    pages_last <- gsub("_citation_page_last", "", pages_last)
    pages_last <- trimws(pages_last)
    
    pages <- paste(pages_first, pages_last, sep = "-")
    
    reference_info <- list(authors = authors,
                           title = title,
                           journal = journal,
                           year = year,
                           volume = volume,
                           pages = pages)
    return(reference_info)
  } else {
    return(NA)
  }
}
```

Extracting from 422:

```{r}
# Initialize an empty list to store the results
results <- list()

for (cif_file in cif_list) {
  # Read the CIF file
  cif_content <- readLines(cif_file)
  
  # Extract the compound name from the file name
  compound_name <- tools::file_path_sans_ext(basename(cif_file))
  
  # Extract the relevant data
  chemical_formula <- extract_chemical_formula(cif_content)
  structure_type <- extract_structure_type(cif_content)
  space_group_name <- extract_space_group_name(cif_content)
  space_group_number <- extract_space_group_number(cif_content)
  reference_info <- extract_reference_info(cif_content)
  
  # Combine the data into a single list
  result <- list(
    compound_name = compound_name,
    chemical_formula = chemical_formula,
    structure_type = structure_type,
    space_group_name = space_group_name,
    space_group_number = space_group_number,
    reference_info = reference_info
  )
  
  # Append the result to the results list
  results <- append(results, list(result))
}

# Convert the results list to a data frame
results_df <- do.call(rbind, lapply(results, as.data.frame))

```